---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import { Image } from "astro:assets";
import heroImage from "../assets/images/Neon 80s Style Food.webp";
import { getFeaturedEvent } from "@utils/collections";

const username = Astro.locals.user?.username;
const { event: latestEvent, dateRange, hasFood } = await getFeaturedEvent();
---

<Layout>
  <Header />
  <main id="main-content" class="layout-stable">
    <div class="loading-placeholder" style="display: none;">
      <div class="flex flex-col gap-12 md:flex-row">
        <div class="w-full md:w-1/2">
          <div
            class="aspect-square w-full max-w-[536px] bg-base-200 animate-pulse rounded-2xl"
          >
          </div>
        </div>
        <div class="w-full md:w-1/2 space-y-4">
          <div class="h-4 bg-base-200 animate-pulse rounded"></div>
          <div class="h-4 bg-base-200 animate-pulse rounded w-3/4"></div>
          <div class="h-4 bg-base-200 animate-pulse rounded w-1/2"></div>
        </div>
      </div>
    </div>

    <section id="hero">
      <div class="flex flex-col gap-2 pb-12">
        <h1 class="font-300 text-base-content pb-8 pt-4 text-center text-3xl">
          {`Welcome to PDX Food Weeks${username ? ", " + username : ""}!`}
        </h1>
        <div class="flex flex-col gap-12 md:flex-row">
          <div class="flex w-full items-center justify-center md:w-1/2">
            <div class="aspect-square w-full max-w-[536px] bg-base-200">
              <Image
                src={heroImage}
                alt="PDX Food Weeks Hero Image"
                width={536}
                height={536}
                class="h-full w-full rounded-2xl shadow-xl object-cover"
                sizes="(max-width: 768px) 398px, 536px"
                loading="eager"
                decoding="sync"
              />
            </div>
          </div>
          <div class="flex w-full flex-col gap-6 md:w-1/2">
            <p class="prose">
              Welcome, fellow foodies, to a celebration of Portland's much-loved
              food weeks put on by local organizers! Here, we're all about
              celebrating the iconic PDX Burger Week, the cheesy goodness of PDX
              Nachos Week, the craft and creativity of PDX Sandwich Week, the
              saucy PDX Pizza Week, and many more!
            </p>
            <p class="prose">
              The site was created to help people filter the options by
              neighborhood and dietary restrictions, while showcasing the
              beautiful creations from each vendor.
            </p>

            <h3 class="text-2xl font-bold">Latest Event</h3>
            <div class="w-100 flex flex-col gap-1">
              {
                latestEvent.ogImage && (
                  <div class="aspect-[536/138] w-full max-w-[536px] bg-base-200">
                    <img
                      src={latestEvent.ogImage}
                      width="536"
                      height="138"
                      class="h-full w-full rounded-lg shadow object-cover"
                      alt={latestEvent.title}
                      loading="eager"
                      decoding="sync"
                    />
                  </div>
                )
              }
              <p class="py-2">
                <a class="link" href={latestEvent.url} target="_blank"
                  >{latestEvent.title}</a
                >. From {dateRange}.
              </p>

              {
                hasFood ? (
                  <wa-button
                    appearance="accent"
                    variant="brand"
                    size="large"
                    href={`/${latestEvent.type}/${latestEvent.year}`}
                  >
                    Check out the {latestEvent.type}s
                  </wa-button>
                ) : (
                  <wa-callout
                    variant="neutral"
                    appearance="plain"
                    class="border-secondary border "
                  >
                    <wa-icon slot="icon" name="info" />
                    <strong>No food items yet for this event</strong>
                    <br />
                    Check back later for updates.
                  </wa-callout>
                )
              }
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  // prevent layout shifts during page load
  document.addEventListener("DOMContentLoaded", function () {
    // ensure all images are loaded before showing content
    const images = document.querySelectorAll("img, [data-astro-asset]");
    let loadedImages = 0;

    if (images.length === 0) {
      // no images to wait for, show content immediately
      return;
    }

    function imageLoaded() {
      loadedImages++;
      if (loadedImages === images.length) {
        // all images loaded, ensure stable layout
        document.body.classList.add("images-loaded");
      }
    }

    images.forEach(img => {
      if (img instanceof HTMLImageElement && img.complete) {
        imageLoaded();
      } else {
        img.addEventListener("load", imageLoaded);
        img.addEventListener("error", imageLoaded); // handle errors too
      }
    });
  });
</script>

<style>
  #hero h1 {
    text-shadow:
      0 0 1px rgba(255, 0, 183, 1),
      0 0 3px rgba(255, 0, 183, 0.6),
      0 0 5px rgba(255, 0, 183, 0.5),
      0 0 7px rgba(255, 0, 183, 0.4),
      0 0 9px rgba(255, 0, 183, 0.3),
      0 0 11px rgba(255, 0, 183, 0.2),
      0 0 13px rgba(255, 0, 183, 0.1);

    [data-theme="cupcake"] & {
      color: white;
    }
  }
</style>
